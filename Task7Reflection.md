Сравнение параметров запроса решения и эталонного ответа:

- squad_id - результат совпадет, однако в эталонном решении этот параметр берётся напрямую из таблицы military_squads. В моём решении для таких параметров выделено отдельное выражение. Эталон предлагает более простое решение не уступающее в читаемости и структурировании.
- squad_name - результат совпадает. Способ получения аналогичен squad_id.
- formation_type - результат совпадает. Способ получения аналогичен squad_id.
- leader_name - результат совпадает. В эталонном ответе этот параметр получается в основном запросе путём объединения таблиц military_squads и dwarves. В моём решении этот параметр относится к выражению squad_stats. В данном случае читаемость равнозначная.
- total_battles - совпадает с эталоном.
- victories - совпадает с эталоном.
- victory_percentage - совпадает с эталоном.
- casualty_rate - совпадает с эталоном. В моём решении допущена ошибка - нет перевода в проценты.
- casualty_exchange_ratio - совпадает с эталоном.
- current_members - совпадает с эталоном, за исключением условия выборки. В эталонном ответе выбираются записи по exit_reason IS NULL, а в моём решении по exit_date IS NULL. Думаю эти различия не существенны, в любом случае оба этих поля должны быть NULL.
- total_members_ever - совпадает с эталоном.
- retention_rate - совпадает с эталоном.
- avg_equipment_quality - совпадает с эталоном.
- total_training_sessions - совпадает с эталоном.
- avg_training_effectiveness - результат совпадет, однако в эталоне есть дополнительное приведение типа к DECIMAL. Похоже подразумевалось, что это поле не числового типа.
- training_battle_correlation - значения различаются. Мой подход оценивает корреляцию между агрегированными средними, что может быть менее устойчиво статистически. Эталонный вариант, использующий бинарный флаг победы, позволяет делать выводы на уровне отдельных наблюдений и потому потенциально более точен. Также эталонные метод учитывает даты тренировок и боёв после них что даёт полезную и информативную статистику.
- avg_combat_skill_improvement - допускаю ошибку как в объединении так и в фильтрации данных. С этой выборкой были трудности, но после изучения ответа всё стало понятно. Как и в первой сложной задаче работаем с двумя копиями таблицы dwarf_skills. Сопоставление выполняем как по dwarf_id, так и по дате вступления в отряд. Вторая копия сопоставляется как по dwarf_id, так и по skill_id с ds_current.date. Тут отдельно хотелось бы отметить, то эталон также можно доработать, поскольку он не учитывает что гном может перейти из одного отряда в другой, и тогда подзапрос с агрегацией `MAX(date)` выдаст неверный результат. Далее также как в моём ответе вычисляется среднее из разниц уровней `AVG(ds_current.level - ds_join.level)`. Для меня было сложностью правильно объединить запросы и отфильтровать данные. На момент написания задания это было не очевидно, сейчас же всё оказалось достаточно просто. 
- overall_effectiveness_score - в целом правильно понимал идею расчёта, однако не учёл всех параметров и весов. По прежнему не понимаю принцип подбора веса поэтому считал только процентные величины. Нужно разобраться в подсчёте таких параметров.
- related_entities - допустил ошибку при расчёте member_ids. Тут нужно выводит только текущих членов отряда, у меня же выводятся все что когда-либо были в отряде. В остальном логика совпадает.

Также заметил у себя ключевую ошибку в способе объединения таблиц. Для CTE я использую LEFT JOIN, а для основного запроса INNER JOIN. В CTE выражениях мне чаще всего  нужно получать только те данные, которые точно совпадают, а для этого нужен INNER JOIN. В основном запросе же наоборот мне нужно на основе всей основной информации собрать остальную, а это уже LEFT JOIN. Похожу нужно больше практики с этим инструментом.

В целом задание получилось лучше чем предыдущие, улучшил группировку, она по большей части совпадает с эталоном, запрос читается легче, логика понятнее. Нужно поработать над сложными запросами ребующими сопоставления разных данных, как в примере с avg_combat_skill_improvement.


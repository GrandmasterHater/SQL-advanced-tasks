### main_stats

- total_recorded_attacks - совпадает.
- unique_attackers - совпадает.
- total_historical_casualties - не готовил такой параметр, однако заметил что таблица creature_attacks не содержит столбец fortress_casualties, возможно в текущей версии БД это именуется как enemy_casualties, но замысел понятен.
- overall_defense_success_rate - логика совпадает. Поделить количество отбитых атак, на общее количество атак. Однако параметры разошлись по значениям, в решении я считают количество атак со статусом "Поражение" для существ, а эталон выбирает атаки со статусом "Отбита". В целом разница небольшая.

### threat_assessment

- current_threat_level - логика получения параметра в решении расходится с эталоном. В решении нахожу средний уровень угрозы и исходя из него конвертирую уровень в статус. Решение же основывается на количестве атак за последние 30, что более логично, поскольку опирается не на усреднённый показатель, а на статистику нападений. Также открыл для себя выражение FILTER которое считает количество строк соответствующее условию в параметре, а также способ получения даты за интервал от указанной даты в виде `CURRENT_DATE - INTERVAL '30 days'` - взял на вооружение.
- active_threats - есть отличия в получении last_sighting_date (в решении делаю поиск максимальной даты т.к. думал что записей для существ может быть несколько и нужно найти последнее), а также в получении creature_ids (в эталоне есть дополнительная фильтрация активных существ, которую я не учёл).
- seasonal_risk_factors - у меня есть аналог параметра в виде seasonal_patterns, однако он существенно уступает по информативности. Эталон делает комплексный анализ на основе фаз луны, записей о погоде и зарегистрированных атаках. Выводится корреляция по температуре, осадкам и фазе луны.

### vulnerability_analysis

В этой части была не очень понятна связь между локациями и зонами. Похоже что она была 1 к 1, хотя я подумал, что в 1 локации может быть несколько зон, т.е. 1 к n.

Также эталонный ответ задействует существенно больше таблиц для составления zone_vulnerability. В целом направление мысли у меня по этому параметру было правильным, но оказалось недостаточно проработанным, снова зациклился на возможных параметрах не взглянув на вопрос шире.

vulnerability_score - снова не смог справиться с расчётом составного параметра с весами, по прежнему не очень понятно как подбирать веса и как соотносить параметры. Недостаёт знаний в аналитике, но это отдельная тема и знания по ней можно подтянуть отдельно.

### defense_effectiveness

Те показатели что есть - совпадают, однако в эталоне выведено больше метрик. Отметил для себя использование ключевого слова CURRENT_DATE для расчёта даты от текущего момента.

### military_readiness_assessment

Структурно также как и в эталоне делаю отдельный CTE для подсчёта этого параметра. Информация в эталоне, как и в остальных местах, более подробная. Из заметных отличий стоит отметить, что combat_effectiveness рассчитывается не просто как отношение побед ко всем сражениям, но еще и учитывает вес среднего боевого навыка, качество экипировки отряда и количество дней последней тренировки. Это безусловно даёт более точную оценку эффективности отряда.

### security_evolution

В CTE за основу расчёта берётся не таблица атак, а таблица событий крепости. Далее данные объединяются с таблицами атак, структур обороны, выражениями zone_vulnerability и military_readiness. Хотя в целом структурирование CTE моего решения и эталона совпадают, эталон гораздо более информативен. 
Из того что заметил - есть выражение `LEFT JOIN zone_vulnerability zv ON 1=1 -- Join all zones for averaging` которое используется просто чтобы соединить 2 таблицы без сопоставления по конкретному столбцу (1=1).

### Итог:

Хотя и в этот раз мой запрос достаточно отдалён от эталонного у меня получилось выстроить похожую структуру запроса и в целом ход мысли был верным. Мне сейчас недостаёт понимания аналитики, того что именно нужно выводить и как считать, но это придёт с опытом, нужно больше практики с аналитическими запросами. 


 















